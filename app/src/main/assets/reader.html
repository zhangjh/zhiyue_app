<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>电子书阅读器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #fafafa;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #chapter-title {
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 20px;
        }
        
        /* 调整viewer位置以适应新增的标题栏 */
        #viewer {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }
        #viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 确保 iframe 内容可以选择文本 */
        #viewer iframe * {
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        
        /* 确保选择菜单在最顶层 */
        #selection-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            z-index: 9999;  /* 保留更高的 z-index */
            min-width: 120px;
        }
                
        /* 添加电子书内容样式 */
        #viewer iframe {
            --bg-color: #fafafa;
            --text-color: #333;
        }
        #viewer * {
            line-height: 1.6 !important;
            font-size: 1.1em !important;
        }
        #viewer p {
            margin: 1em 0 !important;
            padding: 0 10px !important;
        }
        /* 其他样式保持不变 */
        #progress-container {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        /* 添加选择菜单样式 */
        #selection-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            z-index: 1000;
            min-width: 120px;
        }
        
        .menu-button {
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }
        
        .menu-button:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        /* 自定义选中文本的样式 */
        ::selection {
            background: rgba(255,255,0,0.3);
        }
    </style>
</head>
<body>
<div id="chapter-title">正在加载...</div>
<div id="viewer"></div>
<div id="progress-container">阅读进度：0%</div>
<!-- 添加选择菜单 -->
<div id="selection-menu">
    <button class="menu-button" id="copy-btn">复制</button>
    <button class="menu-button" id="highlight-btn">高亮</button>
    <button class="menu-button" id="underline-btn">划线</button>
</div>

<script>
    let book;
    let rendition;
    
    function initializeSelection() {
        const selectionMenu = document.getElementById('selection-menu');
        let currentCfiRange = null;
        let currentContents = null;
        let isSelecting = false;
        let startX, startY;
        let touchStartTime = 0;
        let longPressTimer = null;
        const SWIPE_THRESHOLD = 50;
        const TAP_THRESHOLD = 200;
        const LONG_PRESS_THRESHOLD = 500; // 长按阈值设为500毫秒

        // 添加操作按钮事件监听
        document.body.addEventListener('click', function(e) {
            if (e.target.id === 'copy-btn') handleCopy();
            if (e.target.id === 'highlight-btn') handleHighlight();
            if (e.target.id === 'underline-btn') handleUnderline();
        });
        
        // 操作处理函数
        function handleCopy() {
            const selection = currentContents.document.getSelection();
            if (selection && window.Android) {
                window.Android.copyText(selection.toString());
            }
            selectionMenu.style.display = 'none';
        }
        
        async function handleHighlight() {
            if (currentCfiRange) {
                await rendition.annotations.highlight(currentCfiRange, {}, (e) => {
                    e.target.style.backgroundColor = 'rgba(255,255,0,0.3)';
                });
                selectionMenu.style.display = 'none';
            }
        }
        
        async function handleUnderline() {
            if (currentCfiRange) {
                rendition.annotations.underline(currentCfiRange,
                    {},
                    undefined,
                    "ul",
                    {
                        "border": "none",
                        "stroke": "#3366ff",
                        "stroke-width": "2px"
                    }
                );
                selectionMenu.style.display = 'none';
            }
        }
        
        rendition.hooks.content.register((contents) => {
            currentContents = contents;
            const doc = contents.document;
            
            doc.documentElement.style.webkitUserSelect = 'text';
            doc.documentElement.style.userSelect = 'text';
            
            // 触摸事件处理
            doc.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isSelecting = false;

                // 添加长按定时器
                longPressTimer = setTimeout(() => {
                    isSelecting = true;
                    // 启用文本选择
                    const range = doc.caretRangeFromPoint(startX, startY);
                    if (range) {
                        const selection = doc.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }, LONG_PRESS_THRESHOLD);
            }, { passive: true });
        
            doc.addEventListener('touchmove', (e) => {
                // 如果移动距离超过阈值，取消长按定时器
                const moveX = e.touches[0].clientX;
                const moveY = e.touches[0].clientY;
                if (Math.abs(moveX - startX) > SWIPE_THRESHOLD || 
                    Math.abs(moveY - startY) > SWIPE_THRESHOLD) {
                    clearTimeout(longPressTimer);
                }

                if (isSelecting) {
                    const touch = e.touches[0];
                    const range = doc.caretRangeFromPoint(touch.clientX, touch.clientY);
                    const selection = doc.getSelection();
                    
                    if (range && selection.rangeCount > 0) {
                        selection.extend(range.startContainer, range.startOffset);
                    }
                }
            }, { passive: true });
        
            doc.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
                // 不在这里重置 isSelecting，让 selectionchange 事件处理它
            }, { passive: true });

            // 修改选择变化监听
            doc.addEventListener('selectionchange', () => {
                const selection = doc.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText && isSelecting) {
                    const range = selection.getRangeAt(0);
                    currentCfiRange = contents.cfiFromRange(range);
                    
                    // 获取选中文本的位置
                    const rect = range.getBoundingClientRect();
                    const iframe = document.querySelector('#viewer iframe');
                    const iframeRect = iframe.getBoundingClientRect();
                    
                    // 计算菜单位置
                    const menuWidth = selectionMenu.offsetWidth;
                    const menuHeight = selectionMenu.offsetHeight;
                    
                    let menuLeft = iframeRect.left + rect.left + (rect.width / 2) - (menuWidth / 2);
                    let menuTop = iframeRect.top + rect.bottom + 10;
                    
                    // 确保菜单在视口内
                    menuLeft = Math.max(10, Math.min(menuLeft, window.innerWidth - menuWidth - 10));
                    if (menuTop + menuHeight > window.innerHeight) {
                        menuTop = iframeRect.top + rect.top - menuHeight - 10;
                    }
                    
                    // 显示菜单
                    selectionMenu.style.left = `${menuLeft}px`;
                    selectionMenu.style.top = `${menuTop}px`;
                    selectionMenu.style.display = 'flex';
                }
            });
        
            // 点击其他区域隐藏菜单
            doc.addEventListener('click', (e) => {
                if (!selectionMenu.contains(e.target)) {
                    selectionMenu.style.display = 'none';
                }
            });
        
            // 阻止上下文菜单
            doc.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
        });
    }

    function loadBook(bookUrl) {
        book = ePub(bookUrl);
        rendition = book.renderTo("viewer", {
            flow: "paginated",
            width: "100%",
            height: "100%",
            spread: "none",
            minSpreadWidth: 1000
        });

        // 启用手势支持
        rendition.on("touchstart", event => {
            const touches = event.changedTouches[0];
            touchStartX = touches.screenX;
        });

        rendition.on("touchend", event => {
            const touches = event.changedTouches[0];
            const swipeDistance = touchStartX - touches.screenX;
            
            if (Math.abs(swipeDistance) > 50) {
                if (swipeDistance > 0) {
                    rendition.next();
                } else {
                    rendition.prev();
                }
            }
        });

        rendition.display().then(() => {
            if (window.Android) {
                window.Android.onBookLoaded();
            }
            initializeSelection();
        });

        // 添加章节变化监听
        rendition.on('relocated', (location) => {
            // 获取当前章节信息
            let chapter = book.navigation.get(location.start.href);
            let chapterTitle = chapter ? chapter.label : '';
            document.getElementById('chapter-title').textContent = chapterTitle;

            // 现有的进度更新代码
            let progress = book.locations.percentageFromCfi(location.start.cfi);
            let progressPercent = Math.round(progress * 100);
            document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
            if (window.Android) {
                window.Android.onProgressUpdate(progressPercent);
            }
        });

        // 在进度更新部分修改
        book.ready.then(() => {
            book.locations.generate().then(() => {
                rendition.on('relocated', (location) => {
                    let progress = book.locations.percentageFromCfi(location.start.cfi);
                    let progressPercent = Math.round(progress * 100);
                    // 更新进度显示
                    document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
                    // 通知Android进度更新
                    if (window.Android) {
                        window.Android.onProgressUpdate(progressPercent);
                    }
                });
            });
        });
    }
</script>
</body>
</html>