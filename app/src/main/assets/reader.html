<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>电子书阅读器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #fafafa;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #chapter-title {
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 20px;
        }
        
        /* 调整viewer位置以适应新增的标题栏 */
        #viewer {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }
        #viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* 添加电子书内容样式 */
        #viewer iframe {
            --bg-color: #fafafa;
            --text-color: #333;
        }
        #viewer * {
            line-height: 1.6 !important;
            font-size: 1.1em !important;
        }
        #viewer p {
            margin: 1em 0 !important;
            padding: 0 10px !important;
        }
        /* 其他样式保持不变 */
        #progress-container {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        #prev-btn, #next-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            z-index: 1000;
        }
        #prev-btn { left: 0; }
        #next-btn { right: 0; }
        
        /* 添加选择菜单样式 */
        #selection-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 4px;
            display: none;
            z-index: 1000;
            flex-direction: column;
            gap: 2px;
            min-width: 50px;
        }

        .menu-button {
            padding: 10px 16px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            color: #333;
            background: none;
            border: none;
            border-radius: 8px;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .menu-button:hover {
            background-color: #e0e0e0;
        }

        /* 禁用默认的文本选择菜单 */
        ::selection {
            background: rgba(255, 255, 0, 0.3);
        }
    </style>
</head>
<body>
<div id="chapter-title">正在加载...</div>
<div id="viewer"></div>
<button id="prev-btn">&lt;</button>
<button id="next-btn">&gt;</button>
<div id="progress-container">阅读进度：0%</div>
<!-- 添加选择菜单 -->
<div id="selection-menu">
    <button class="menu-button" id="copy-btn">复制</button>
    <button class="menu-button" id="highlight-btn">高亮</button>
    <button class="menu-button" id="underline-btn">划线</button>
</div>

<script>
    let book;
    let rendition;

    function initializeSelection() {
        let selectionMenu = document.getElementById('selection-menu');
        let currentCfiRange = null;
        let currentContents = null;
        let isLongPress = false;
        let longPressTimer;

        // 确保初始状态菜单是隐藏的
        selectionMenu.style.display = 'none';

        // 添加长按检测
        rendition.on("touchstart", function(event) {
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
            }, 500);
        });

        rendition.on("touchend", function(event) {
            clearTimeout(longPressTimer);
            if (!isLongPress) {
                selectionMenu.style.display = 'none';
            }
        });

        // 选择文本时显示菜单
        rendition.on("selected", function(cfiRange, contents) {
            if (!isLongPress) {
                selectionMenu.style.display = 'none';
                return;
            }
            
            currentCfiRange = cfiRange;
            currentContents = contents;
            const selection = contents.window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const menuHeight = selectionMenu.offsetHeight;
                const viewportHeight = window.innerHeight;

                // 先显示菜单以获取其实际宽度
                selectionMenu.style.display = 'flex';
                const menuWidth = selectionMenu.offsetWidth;

                // 计算菜单位置
                let menuLeft = rect.left + (rect.width / 2) - (menuWidth / 2);
                let menuTop;

                // 检查下方空间是否足够
                if (rect.bottom + menuHeight + 10 <= viewportHeight) {
                    // 显示在下方
                    menuTop = rect.bottom + 10;
                } else {
                    // 空间不足，显示在上方
                    menuTop = rect.top - menuHeight - 10;
                }

                // 确保菜单不会超出屏幕左右边界
                menuLeft = Math.max(10, Math.min(menuLeft, window.innerWidth - menuWidth - 10));

                // 设置菜单位置
                selectionMenu.style.left = `${menuLeft}px`;
                selectionMenu.style.top = `${menuTop}px`;
            }
        });

        // 监听整个文档的点击事件
        document.addEventListener('mouseup', (e) => {
            // 如果点击的不是菜单内的元素，且菜单正在显示
            if (!selectionMenu.contains(e.target) && selectionMenu.style.display === 'block') {
                // 延迟执行，等待 selected 事件处理完
                setTimeout(() => {
                    // 再次检查是否有选中的文本
                    const selection = window.getSelection();
                    if (selection.toString().trim() === '') {
                        selectionMenu.style.display = 'none';
                    }
                }, 10);
            }
        });

        // 菜单按钮点击事件
        document.getElementById('copy-btn').addEventListener('click', () => {
            const selectedText = currentContents.window.getSelection().toString();
            if (window.Android) {
                window.Android.copyText(selectedText);
            }
            selectionMenu.style.display = 'none';
        });

        document.getElementById('highlight-btn').addEventListener('click', () => {
            rendition.annotations.add(
                "highlight",
                currentCfiRange,
                {},
                undefined,
                "hl",
                {
                    "fill": "yellow",
                    "fill-opacity": "0.3"
                }
            );
            selectionMenu.style.display = 'none';
            window.removeEventListener('click', hideMenu);
        });

        document.getElementById('underline-btn').addEventListener('click', () => {
            rendition.annotations.add(
                "underline",
                currentCfiRange,
                {},
                undefined,
                "ul",
                {
                    "stroke": "#3366ff",
                    "stroke-width": "2px"
                }
            );
            selectionMenu.style.display = 'none';
            window.removeEventListener('click', hideMenu);
        });
    }

    // 在加载书籍后初始化选择功能
    rendition.display().then(() => {
        if (window.Android) {
            window.Android.onBookLoaded();
        }
    });

    // 从Android获取书籍URL
    function loadBook(bookUrl) {
        book = ePub(bookUrl);
        rendition = book.renderTo("viewer", {
            flow: "paginated",
            width: "100%",
            height: "100%",
            spread: "none",
            minSpreadWidth: 1000
        });

        rendition.display().then(() => {
            if (window.Android) {
                window.Android.onBookLoaded();
            }
        });

        // 添加章节变化监听
        rendition.on('relocated', (location) => {
            // 获取当前章节信息
            let chapter = book.navigation.get(location.start.href);
            let chapterTitle = chapter ? chapter.label : '';
            document.getElementById('chapter-title').textContent = chapterTitle;

            // 现有的进度更新代码
            let progress = book.locations.percentageFromCfi(location.start.cfi);
            let progressPercent = Math.round(progress * 100);
            document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
            if (window.Android) {
                window.Android.onProgressUpdate(progressPercent);
            }
        });

        // 添加触摸事件监听
        let touchStartX = 0;
        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            let touchEndX = e.changedTouches[0].screenX;
            let diff = touchStartX - touchEndX;

            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    rendition.next();
                } else {
                    rendition.prev();
                }
            }
        });

        // 按钮点击事件
        document.getElementById('prev-btn').addEventListener('click', () => {
            rendition.prev();
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            rendition.next();
        });

        // 在进度更新部分修改
        book.ready.then(() => {
            book.locations.generate().then(() => {
                rendition.on('relocated', (location) => {
                    let progress = book.locations.percentageFromCfi(location.start.cfi);
                    let progressPercent = Math.round(progress * 100);
                    // 更新进度显示
                    document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
                    // 通知Android进度更新
                    if (window.Android) {
                        window.Android.onProgressUpdate(progressPercent);
                    }
                });
            });
        });
        // 初始化长按选择
        initializeSelection();
    }
</script>
</body>
</html>