<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>电子书阅读器</title>
    <script src="file:///android_asset/jszip.min.js"></script>
    <script src="file:///android_asset/epub.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #fafafa;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            margin-top: env(safe-area-inset-top);
            margin-bottom: env(safe-area-inset-bottom);
        }

        #chapter-title {
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 50px;  /* 增加左右padding，避免与目录按钮重叠 */
        }
        
        /* 调整viewer位置以适应新增的标题栏 */
        #viewer {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #viewer iframe {
            width: 100%;
            height: 100%;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            --text-color: #333;
        }
        
        /* 确保 iframe 内容可以选择文本 */
        #viewer iframe * {
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        
        /* 确保选择菜单在最顶层 */
        #selection-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            z-index: 9999;  /* 保留更高的 z-index */
            min-width: 120px;
        }

        #viewer * {
            line-height: 1.6 !important;
            font-size: 1.1em !important;
        }
        #viewer p {
            margin: 1em 0 !important;
            padding: 0 10px !important;
        }
        #progress-container {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: #666;
            background: #fafafa;
            position: sticky;
            bottom: 0;
            z-index: 100;
            padding: 5px 0;
            margin-bottom: 50px;
        }
        
        #selection-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            z-index: 1000;
            min-width: 120px;
        }
        
        .menu-button {
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }
        
        .menu-button:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        /* 自定义选中文本的样式 */
        ::selection {
            background: rgba(255,255,0,0.3);
        }

        /* 添加目录样式 */
        #toc-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            height: 100%;
            background: white;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top); /* 适配刘海屏 */
        }
        
        #toc-header {
            padding: 15px;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 24px;  /* 固定高度确保对齐 */
        }
        
        #toc-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 500;
            line-height: 24px;  /* 与容器高度一致 */
        }

        #toc-header .close {
            padding: 8px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }
        
        #toc-header .menu-button {
            padding: 6px 12px;
            color: #666;
            background: none;
            border: none;
            font-size: 14px;
            padding: 4px 12px;
            height: 24px;     /* 与标题高度一致 */
            line-height: 16px;  /* 文字垂直居中 */
            color: #666;
            background: none;
            border: none;
            font-size: 14px;
        }
        
        /* 修改目录内容区样式 */
        #toc-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .toc-item {
            padding: 12px 15px;
            color: #333;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
        }
        
        /* 修改目录按钮定位 */
        #toc-button {
            position: absolute;
            top: 5px;
            left: 10px;
            z-index: 999;
            padding: 8px 12px;  /* 调整内边距，让按钮更宽一些 */
            background: white;
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: pointer;
            height: 30px;
            line-height: 14px;
            min-width: 40px;      /* 确保按钮有足够宽度 */
            text-align: center;   /* 文字居中 */
        }

        /* 确保目录容器在打开时正确显示 */
        #toc-container.active {
            transform: translateX(0);
            visibility: visible;
        }
        .toc-item:active {
            background-color: #f0f0f0;
        }

        .toc-item:hover {
            color: #007AFF;
        }
    </style>
</head>
<body>
<div id="chapter-title"></div>
<button id="toc-button">目录</button>
<div id="toc-container">
    <div id="toc-header">
        <h3>目录</h3>
        <button class="close" onclick="closeToc()">关闭</button>
    </div>
    <div id="toc-content"></div>
</div>
<div id="viewer"></div>
<div id="progress-container">阅读进度：0%</div>
<!-- 添加选择菜单 -->
<div id="selection-menu">
    <button class="menu-button" id="copy-btn">复制</button>
    <button class="menu-button" id="highlight-btn">高亮</button>
    <button class="menu-button" id="underline-btn">划线</button>
</div>

<script>
    let book;
    let rendition;
    
    function initializeSelection() {
        const selectionMenu = document.getElementById('selection-menu');
        let currentCfiRange = null;
        let currentContents = null;
        let isSelecting = false;
        let startX, startY;
        let touchStartTime = 0;
        let longPressTimer = null;
        const SWIPE_THRESHOLD = 50;
        const TAP_THRESHOLD = 200;
        const LONG_PRESS_THRESHOLD = 500; // 长按阈值设为500毫秒

        // 添加操作按钮事件监听
        document.body.addEventListener('click', function(e) {
            if (e.target.id === 'copy-btn') handleCopy();
            if (e.target.id === 'highlight-btn') handleHighlight();
            if (e.target.id === 'underline-btn') handleUnderline();
        });
        
        // 操作处理函数
        function handleCopy() {
            const selection = currentContents.document.getSelection();
            if (selection && window.Android) {
                window.Android.copyText(selection.toString());
            }
            selectionMenu.style.display = 'none';
        }
        
        async function handleHighlight() {
            if (currentCfiRange) {
                const selection = currentContents.document.getSelection();
                const text = selection.toString();
                await rendition.annotations.highlight(currentCfiRange, {}, (e) => {
                    e.target.style.backgroundColor = 'rgba(255,255,0,0.3)';
                });
                // 保存高亮
                if (window.Android) {
                    window.Android.saveAnnotation(
                        currentCfiRange,
                        'highlight',
                        'rgba(255,255,0,0.3)',
                        text
                    );
                }
                selectionMenu.style.display = 'none';
            }
        }
        
        async function handleUnderline() {
            if (currentCfiRange) {
                const selection = currentContents.document.getSelection();
                const text = selection.toString();
                rendition.annotations.underline(currentCfiRange,
                    {},
                    undefined,
                    "ul",
                    {
                        "border": "none",
                        "stroke": "#3366ff",
                        "stroke-width": "2px"
                    }
                );
                // 保存下划线
                if (window.Android) {
                    window.Android.saveAnnotation(
                        currentCfiRange,
                        'underline',
                        '#3366ff',
                        text
                    );
                }
                selectionMenu.style.display = 'none';
            }
        }
        
        // 添加目录按钮点击事件
        document.getElementById('toc-button').addEventListener('click', toggleToc);

        rendition.hooks.content.register((contents) => {
            currentContents = contents;
            const doc = contents.document;
            
            doc.documentElement.style.webkitUserSelect = 'text';
            doc.documentElement.style.userSelect = 'text';
            
            // 触摸事件处理
            doc.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isSelecting = false;

                // 添加长按定时器
                longPressTimer = setTimeout(() => {
                    isSelecting = true;
                    // 启用文本选择
                    const range = doc.caretRangeFromPoint(startX, startY);
                    if (range) {
                        const selection = doc.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }, LONG_PRESS_THRESHOLD);
            }, { passive: true });
        
            doc.addEventListener('touchmove', (e) => {
                // 如果移动距离超过阈值，取消长按定时器
                const moveX = e.touches[0].clientX;
                const moveY = e.touches[0].clientY;
                if (Math.abs(moveX - startX) > SWIPE_THRESHOLD || 
                    Math.abs(moveY - startY) > SWIPE_THRESHOLD) {
                    clearTimeout(longPressTimer);
                }

                if (isSelecting) {
                    const touch = e.touches[0];
                    const range = doc.caretRangeFromPoint(touch.clientX, touch.clientY);
                    const selection = doc.getSelection();
                    
                    if (range && selection.rangeCount > 0) {
                        selection.extend(range.startContainer, range.startOffset);
                    }
                }
            }, { passive: true });
        
            doc.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
                // 不在这里重置 isSelecting，让 selectionchange 事件处理它
            }, { passive: true });

            // 修改选择变化监听
            doc.addEventListener('selectionchange', () => {
                const selection = doc.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText && isSelecting) {
                    const range = selection.getRangeAt(0);
                    currentCfiRange = contents.cfiFromRange(range);
                    
                    // 获取选中文本的位置
                    const rect = range.getBoundingClientRect();
                    const iframe = document.querySelector('#viewer iframe');
                    const iframeRect = iframe.getBoundingClientRect();
                    
                    // 计算菜单位置
                    const menuWidth = selectionMenu.offsetWidth;
                    const menuHeight = selectionMenu.offsetHeight;
                    
                    let menuLeft = iframeRect.left + rect.left + (rect.width / 2) - (menuWidth / 2);
                    let menuTop = iframeRect.top + rect.bottom + 10;
                    
                    // 确保菜单在视口内
                    menuLeft = Math.max(10, Math.min(menuLeft, window.innerWidth - menuWidth - 10));
                    if (menuTop + menuHeight > window.innerHeight) {
                        menuTop = iframeRect.top + rect.top - menuHeight - 10;
                    }
                    
                    // 显示菜单
                    selectionMenu.style.left = `${menuLeft}px`;
                    selectionMenu.style.top = `${menuTop}px`;
                    selectionMenu.style.display = 'flex';
                }
            });
        
            // 点击其他区域隐藏菜单
            doc.addEventListener('click', (e) => {
                if (!selectionMenu.contains(e.target)) {
                    selectionMenu.style.display = 'none';
                }
            });
        
            // 阻止上下文菜单
            doc.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
        });
    }

    function loadBook(bookUrl) {
        console.log("bookUrl: " + bookUrl);
        book = ePub(bookUrl);
        // 添加错误处理
        book.on('openFailed', function(error) {
            console.error("Failed to open book:", error);
            if (window.Android) {
                window.Android.onLoadError("加载电子书失败：" + error.message);
            }
        });
        rendition = book.renderTo("viewer", {
            flow: "paginated",
            width: "100%",
            height: "100%",
            spread: "none",
            minSpreadWidth: 1000
        });

        // 添加目录功能
        book.loaded.navigation.then(nav => {
            const toc = nav.toc;
            const tocContent = document.getElementById('toc-content');
            tocContent.innerHTML = ''; // 清空现有内容
            
            toc.forEach(chapter => {
                const div = document.createElement('div');
                div.className = 'toc-item';
                div.textContent = chapter.label;
                div.onclick = () => {
                    rendition.display(chapter.href);
                    closeToc();
                };
                tocContent.appendChild(div);
            });
        });

        // 添加加载标注方法
        window.loadAnnotations = function(annotationsJson) {
            console.log("Received annotations:", annotationsJson);  // 添加日志
             // 解析JSON字符串
            const annotations = JSON.parse(annotationsJson);
            // 检查是否有data字段（因为后端返回的是BizListResponse）
            const annotationList = annotations.data || [];

            annotations.forEach(annotation => {
                if (annotation.type === 'highlight') {
                    rendition.annotations.highlight(
                        annotation.cfiRange,
                        {},
                        (e) => {
                            e.target.style.backgroundColor = annotation.color;
                        }
                    );
                } else if (annotation.type === 'underline') {
                    rendition.annotations.underline(
                        annotation.cfiRange,
                        {},
                        undefined,
                        "ul",
                        {
                            "border": "none",
                            "stroke": annotation.color,
                            "stroke-width": "2px"
                        }
                    );
                }
            });
        };
    
        // 在书籍加载完成后加载标注
        rendition.display().then(() => {
            console.log("display completed, annotationsLoaded");
            if (window.Android) {
                window.Android.onBookLoaded();
                // 加载已存在的标注
                window.Android.loadAnnotations();
            }
            initializeSelection();
        });

        // 启用手势支持
        rendition.on("touchstart", event => {
            const touches = event.changedTouches[0];
            touchStartX = touches.screenX;
        });

        rendition.on("touchend", event => {
            const touches = event.changedTouches[0];
            const swipeDistance = touchStartX - touches.screenX;
            
            if (Math.abs(swipeDistance) > 50) {
                if (swipeDistance > 0) {
                    rendition.next();
                } else {
                    rendition.prev();
                }
            }
        });

        // 添加章节变化监听
        rendition.on('relocated', (location) => {
            // 获取当前章节信息
            for(let item of book.navigation.toc) {
                if(item.href.indexOf(location.start.href) !== -1) {
                    let chapterTitle = item.label.trim();
                    document.getElementById('chapter-title').textContent = chapterTitle || '无标题';
                    break;
                }
            }

            // 现有的进度更新代码
            let progress = book.locations.percentageFromCfi(location.start.cfi);
            let progressPercent = Math.round(progress * 100);
            document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
            if (window.Android) {
                window.Android.onProgressUpdate(progressPercent);
            }
        });

        // 在进度更新部分修改
        book.ready.then(() => {
            book.locations.generate().then(() => {
                rendition.on('relocated', (location) => {
                    let progress = book.locations.percentageFromCfi(location.start.cfi);
                    let progressPercent = Math.round(progress * 100);
                    // 更新进度显示
                    document.getElementById('progress-container').textContent = `阅读进度：${progressPercent}%`;
                    // 通知Android进度更新
                    if (window.Android) {
                        window.Android.onProgressUpdate(progressPercent);
                    }
                });
            });
        });
    }

    // 添加目录控制函数
    function toggleToc() {
        const tocContainer = document.getElementById('toc-container');
        tocContainer.classList.toggle('active');
    }

    function closeToc() {
        const tocContainer = document.getElementById('toc-container');
        tocContainer.classList.remove('active');
    }
</script>
</body></html>
